---
title: 'Statistical report: Quality indicators for heart failure: a validation study using nationwide registry data – a SwedeHF study'
subtitle: 'DRAFT'
author: 'Statistician: Lina Benson'
  
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 7
    number_sections: yes
link-citations: yes
bibliography: references.bib
nocite: '@*'
urlcolor: blue
linkcolor: black
header-includes:
   - \usepackage{draftwatermark}
---

\newpage 
\tableofcontents 
\listoftables
\listoffigures
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, include = TRUE, comment = "",
  warning = FALSE, message = FALSE, fig.pos = "H",
  fig.path = "../output/figs/"
)
options(knitr.kable.NA = "")
```

```{r adjust_directory_if_needed, include=FALSE}
# Uncomment lines below if rmd file is placed in a subdirectory
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

```{r load_project}
# 1. Set options in config/global.dcf
# 2. Load packages listed in config/global.dcf
# 3. Import functions and code in lib directory

ProjectTemplate::reload.project()

cacheon <- TRUE
```             

# Data handling

## Data source

The same raw data as SHFDB3, https://kiheartfailure.github.io/shfdb3/. 
In order to include patients up until 2019-12-31 the data management 
was however performed separatly for this analyses. 

## Inclusion/exclusion criteria

```{r flow}
default_kable(flow, caption = "Flowchart")
```

FRÅGA: OK till sel kritier? 

First patient in: `r min(rsdata$shf_indexdtm)` and last patient in: `r max(rsdata$shf_indexdtm)`.  

The median age (IQR) is `r rsdata %>% summarise(med = fn(median(shf_age), dig = 1),
                                             q1 = fn(quantile(shf_age, probs = 0.25), dig = 1),
                                             q3 = fn(quantile(shf_age, probs = 0.75), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", q1, "-", q3, ")")) %>%
                                   pull(out)` and 
`r rsdata %>% count(shf_sex) %>%
  mutate(perc = fn(n / sum(n) * 100, 1)) %>%
  filter(shf_sex == "Female") %>%
  pull(perc)`% females.    

## Created variables 

```{r npr}
default_kable(metaout, caption = "Outcomes and comorbidities from NPR")
```

FRÅGA: OK till defintioner?

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with some care.

## Missing data

Missing data was imputed with multiple imputation (n = 10) using mice [@mice] 
for the multivariable Cox regression models. 
Variables included in the model are indicated in 
Table \ref{tab:tab1}. All-cause mortality was included as the Nelson-Aalen estimator. 

FRÅGA: OK till ovan? 

## Baseline characteristics

FRÅGA: Jag öste på och modifierade variabler lite mot sapen, både för justering och i tabellen. Kolla och se om OK.

```{r, child = "../src/tab1.Rmd"}

```

## Feasibility and attainment assessment

FRÅGA: I baseline tabellen och liklihood har du velat dela upp på in/out-patint, kön och ålder. 
I denna tab vill du dela upp på EF (men ej in/out-pat), kön och ålder. 
Föreslår att du gör på samma sätt i alla tabeller, om det inte finns en väldigt bra skäl att göra olika.
Kanske dela upp på alla 4?

```{r, child = "../src/feasability.Rmd"}

```

## Likelihood of attainment for each of the 2021 ESC QIs for HF

```{r, child = "../src/logreg.Rmd"}

```

## Outcome analysis

The following outcomes are considered: 

- All-cause mortality
- First Heart failure hospitalization (HFH)
- CV mortailty. FRÅGA: står olika på olika ställen i sap, ska vara med eller ej?

Data were censored at 2019-12-31, death (for the outcome HFH) or emigration from Sweden. 

All-cause mortality was presented with a Kaplan-Meier curve and first 
HFH with a cumulative incidence curve considering death as a competing event. Cox proportional hazards regressions were 
used to model the time to first event analysis. Variables included in the model are indicated in 
Table \ref{tab:tab1}.

### Assumptions

The proportional hazards assumption was investigated using the scaled Schoenfeld 
residuals (cox.zph in [@survival-package]) for the primary outcome. 
Possible outliers were visually inspected by plotting the dfbetas. 
=> XXXX. 

The median (min-max) follow-up is 
`r rsdata %>% summarise(med = fn(median(sos_outtime_death / 365.25 * 12), dig = 1),
                                             min = fn(min(sos_outtime_death / 365.25 * 12), dig = 1),
                                             max = fn(max(sos_outtime_death / 365.25 * 12), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", min, "-", max, ")")) %>%
                                   pull(out)` months for a total of 
                                   `r rsdata %>% summarise(sumpy = fn(sum(sos_outtime_death) / 365.25, dig = 0)) %>%
                                   pull(sumpy)` patient-years of follow-up.


```{r, child = "../src/km.Rmd"}

```

#```{r, child = "../src/outtab.Rmd"}

#```

\clearpage
\newpage

# Reproducibility

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

## R code

The R code for all data handling and statistical analyses are found: 
https://github.com/KIHeartFailure/validation_qi. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

# References