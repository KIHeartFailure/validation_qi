```{r km, cache=cacheon}

kmfunc <- function(qi, time, event, eventname, yposplus = NULL) {
  cexmy <- 1.2
  endtime <- 6

  fits <- survfit(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ ", qi)),
    data = rsdata
  )

  levs <- levels(rsdata %>% pull(!!sym(qi)))
  levsr <- str_replace_all(levs, "ob\\d", "")
  levsr <- str_replace_all(levsr, "sens", "")

  nlevs <- length(levsr)
  # c(bottom, left, top, right)
  if (nlevs == 2) {
    par(mar = c(6.5, 8.6, 1, 4.25) + 0.1)
    cols <- global_colsblue[c(2, 5)]
  }
  if (nlevs == 4) {
    par(mar = c(8.5, 8.6, 1, 4.25) + 0.1)
    cols <- global_colsblue[c(1, 3, 5, 7)]
  }

  plots <- plot(fits,
    fun = "event",
    ylab = eventname,
    xscale = 365,
    yscale = 100,
    col = global_colsblue[c(2, 5)],
    mark.time = FALSE,
    bty = "n",
    xlim = c(0, endtime * 365),
    ylim = c(0, 1),
    xlab = "Years",
    cex.lab = cexmy,
    axes = F,
    lwd = 3,
    lty = 1:4,
    xaxs = "i", yaxs = "i"
  )

  axis(2, seq(0, 1, 0.25), seq(0, 100, 25), las = 2, cex.axis = cexmy)
  axis(1, at = seq(0, endtime, 1) * 365, seq(0, endtime, 1), cex.axis = cexmy)

  ypos <- 1 - summary(fits, 364 * endtime, extend = T)$surv

  if (is.null(yposplus)) yposplus <- rep(0, nlevs)

  ylabs <- bind_cols(
    ypos = c(ypos + yposplus),
    ytext = levsr
  )

  mtext(
    side = 4,
    line = .2,
    at = ylabs$ypos,
    ylabs$ytext,
    las = 1,
    cex = cexmy,
  )

  nrisk <- summary(fits, seq(0, endtime, 1) * 365, extend = T)

  if (nlevs == 2) {
    mtext("No. at risk", side = 1, line = 3.5, at = -540, adj = 0, cex = cexmy, font = 2)
    mtext(levsr[1], side = 1, line = 4.5, at = -540, adj = 0, cex = cexmy)
    mtext(levsr[2], side = 1, line = 5.5, at = -540, adj = 0, cex = cexmy)

    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=No")],
      line = 3.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=Yes")],
      line = 4.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
  }

  if (nlevs == 4) {
    mtext("No. at risk", side = 1, line = 3.5, at = -540, adj = 0, cex = cexmy, font = 2)
    mtext(levsr[1], side = 1, line = 4.5, at = -540, adj = 0, cex = cexmy)
    mtext(levsr[2], side = 1, line = 5.5, at = -540, adj = 0, cex = cexmy)
    mtext(levsr[3], side = 1, line = 6.5, at = -540, adj = 0, cex = cexmy)
    mtext(levsr[4], side = 1, line = 7.5, at = -540, adj = 0, cex = cexmy)

    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=", levs[1])],
      line = 3.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=", levs[2])],
      line = 4.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=", levs[3])],
      line = 5.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
    axis(1,
      at = seq(0, endtime, 1) * 365, labels = nrisk$n.risk[nrisk$strata == paste0(qi, "=", levs[4])],
      line = 6.5, tick = FALSE, cex.axis = cexmy, gap.axis = -10000000
    )
  }
}



kmfunc2 <- function() {
  kmfunc(
    qi = qivars[1],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[2],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[3],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[4],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[5],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[6],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[7],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[8],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[9],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[10],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[11],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[12],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[13],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[14],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = qivars[15],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = compqivarsuse[1],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = compqivarsuse[2],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = compqivarsuse[3],
    time = time2,
    event = event2,
    eventname = eventname2
  )
  kmfunc(
    qi = compqivarsuse[4],
    time = time2,
    event = event2,
    eventname = eventname2
  )
}

qinames <- str_replace_all(qivars, "qi\\d_\\d", "")
qinames <- str_replace_all(qinames, "_sens", " sensitivity")

compqivarsuse <- compqivars[!compqivars %in% c("comp_qi_opbased1", "comp_qi_opbased2", "comp_qi_opbased2_sens")]
qicompnames <- str_replace_all(compqivarsuse, "_qi_", "")
qicompnames <- str_replace_all(qicompnames, "_cat", "cat")
qicompnames <- str_replace_all(qicompnames, "_sens", " sensitivity")
```

```{r deathcvhosphf, cache = cacheon, dependson="km", fig.cap = "CV mortality/First HFH", fig.show='hold', out.width="20%", out.height="25%", fig.subcap=c(qinames, qicompnames), fig.ncol=4}

time2 <- "sos_outtime_hosphf"
event2 <- "sos_out_deathcvhosphf"
eventname2 <- "CV mortality/First HFH (%)"

kmfunc2()
```             

```{r deathcv, cache = cacheon, dependson="km", fig.cap = "CV mortality", fig.show='hold', out.width="20%", out.height="25%", fig.subcap=c(qinames, qicompnames), fig.ncol=4}

time2 <- "sos_outtime_death"
event2 <- "sos_out_deathcv"
eventname2 <- "CV mortality (%)"

kmfunc2()
```             

```{r hosphf, cache = cacheon, dependson="km", fig.cap = "First HFH", fig.show='hold', out.width="20%", out.height="25%", fig.subcap=c(qinames, qicompnames), fig.ncol=4}

time2 <- "sos_outtime_hosphf"
event2 <- "sos_out_hosphf"
eventname2 <- "First HFH (%)"

kmfunc2()
```             

```{r death, cache = cacheon, dependson="km", fig.cap = "AC mortality", fig.show='hold', out.width="20%", out.height="25%", fig.subcap=c(qinames, qicompnames), fig.ncol=4}

time2 <- "sos_outtime_death"
event2 <- "sos_out_death"
eventname2 <- "All-cause mortality (%)"

kmfunc2()
```             
