```{r logreg, cache=cacheon}

xvars <- c("shf_ef_cat", "shf_location", "shf_sex", "shf_age_cat")

orfunc <- function(qi) {
  out <- data.frame(matrix(NA, ncol = 9, nrow = 1))

  colnames(out) <- c(
    "QI",
    levels(rsdata %>% pull(!!sym(xvars[1]))),
    levels(rsdata %>% pull(!!sym(xvars[2]))),
    levels(rsdata %>% pull(!!sym(xvars[3]))),
    levels(rsdata %>% pull(!!sym(xvars[4])))
  )

  out[1, 1] <- qi

  for (i in seq_along(xvars)) {
    checkav <- rsdata %>%
      filter(!is.na(!!sym(qi)) & !is.na(!!sym(xvars[i]))) %>%
      count(!!sym(qi), !!sym(xvars[i])) %>%
      count() %>%
      pull(n)

    if (checkav < 4) {
      out[(i * 2):(i * 2 + 1)] <- c("-", "-")
    }
    if (checkav == 4) {
      mod <- summary(lme4::glmer(formula(paste0(qi, " == 'Yes' ~ ", xvars[i], " + (1 | shf_centre)")),
        family = "binomial",
        data = rsdata
      ))

      out[(i * 2):(i * 2 + 1)] <- c(
        "ref",
        paste0(
          fn(exp(mod$coefficients[2, "Estimate"]), 2),
          " (",
          fn(exp(mod$coefficients[2, "Estimate"] - global_z05 * mod$coefficients[2, "Std. Error"]), 2),
          "-",
          fn(exp(mod$coefficients[2, "Estimate"] + global_z05 * mod$coefficients[2, "Std. Error"]), 2),
          "), ",
          fn(mod$coefficients[2, "Pr(>|z|)"], 3, p = T)
        )
      )
    }
  }
  return(out)
}

for (j in seq_along(qivars)) {
  tmpqior <- orfunc(qivars[j])
  if (j == 1) {
    qior <<- tmpqior
  } else {
    qior <<- rbind(qior, tmpqior)
  }
}


default_kable(qior,
  font_size = 6,
  caption = "Likelihood of attainment",
  escape = TRUE
) %>%
  add_header_above(c(" " = 1, "EF" = 2, "Location" = 2, "Sex" = 2, "Age" = 2))
```
