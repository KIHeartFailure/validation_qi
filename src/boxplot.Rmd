```{r boxplotfunc, cache=cacheon, fig.cap="Distribution of hospitals performance (opportunity based scores distribution for >= median)", fig.width=9, fig.height=6}

qivarsuse <- c(qivars, compqicatvars)

for (i in seq_along(qivarsuse)) {
  tmp <- rsdata %>%
    filter(!is.na(!!sym(qivarsuse[i]))) %>%
    group_by(shf_centre) %>%
    count(!!sym(qivarsuse[i]), .drop = F) %>%
    mutate(
      tot = sum(n),
      percent = as.numeric(fn(n / tot * 100, 0))
    ) %>%
    ungroup() %>%
    filter(!!sym(qivarsuse[i]) %in% c("Yes", ">= median")) %>%
    filter(tot > 10) %>%
    select(shf_centre, percent) %>%
    mutate(
      qivar = qivarsuse[i],
      qinum = i
    )

  if (i == 1) {
    qidata <<- tmp
  }
  if (i > 1) {
    qidata <<- bind_rows(qidata, tmp)
  }
}

qidata <- left_join(qidata, qivarsmeta %>% select(-noadjvars), by = "qivar")

qidata$qiname <- forcats::fct_reorder(qidata$qiname, qidata$qinum)

cexmy <- 1.5
# c(bottom, left, top, right)
par(mar = c(6.5, 4, 0, 0) + 0.1)

b <- boxplot(percent ~ qiname,
  data = qidata, col = global_colsblue[5],
  ylab = "Distributation of hospital performance (%)", xlab = "", axes = FALSE, cex.lab = cexmy
)
axis(1, at = 1:16, b$names, tick = TRUE, cex.axis = cexmy, gap.axis = -10000000, las = 2)
axis(2, cex.axis = cexmy, las = 2)
box(bty = "l")
```
